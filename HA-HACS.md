# MyLog Home Assistant Integration - Implementation Guide

This document provides detailed instructions for implementing a Home Assistant HACS integration for the mylog logging service.

## Overview

Create a custom Home Assistant integration that allows users to send log entries to their mylog instance. The integration should be distributed via HACS (Home Assistant Community Store).

## Repository Structure

Create a new repository named `homeassistant-mylog` with this structure:

```
homeassistant-mylog/
├── README.md
├── LICENSE
├── hacs.json
├── custom_components/
│   └── mylog/
│       ├── __init__.py
│       ├── manifest.json
│       ├── config_flow.py
│       ├── const.py
│       ├── api.py
│       ├── services.yaml
│       ├── strings.json
│       └── translations/
│           ├── en.json
│           └── de.json
```

## API Specification

### Base URL

The mylog API is always available at:

```
https://mylog.zip/fastAPI/
```

This is the fixed production URL - users do not need to configure it.

### Authentication

API key authentication via header. Support both formats:

```
Authorization: Bearer mlk_xxxxx...
```
or
```
X-API-Key: mlk_xxxxx...
```

API keys are generated by users in the mylog web application and start with `mlk_` prefix.

### Endpoints

#### Health Check
```
GET /health

Response:
{
  "status": "ok",
  "version": "0.1.0",
  "database": "connected"
}
```

#### Create Single Log Entry
```
POST /api/v1/logs
Content-Type: application/json
X-API-Key: mlk_xxxxx...

Request Body:
{
  "title": "string (optional, max 500 chars)",
  "content": "string (optional)",
  "type_name": "string (optional) - resolves to user's log type",
  "type_id": "integer (optional) - alternative to type_name",
  "severity": "info|low|medium|high|critical (default: info)",
  "priority": "0-100 (default: 0)",
  "status": "draft|active|archived (default: active)",
  "tags": ["array", "of", "strings"],
  "location_name": "string (optional, max 255 chars)",
  "location_lat": "float -90 to 90 (optional)",
  "location_lng": "float -180 to 180 (optional)",
  "occurred_at": "ISO 8601 datetime (optional)",
  "is_favourite": "boolean (default: false)",
  "is_starred": "boolean (default: false)",
  "is_pinned": "boolean (default: false)",
  "is_public": "boolean (default: false)",
  "external_ref_id": "string (optional, max 255 chars)"
}

Success Response (201):
{
  "success": true,
  "entry": {
    "id": 123,
    "uuid": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": 1,
    "title": "...",
    "content": "...",
    "source": "api",
    "created_at": "2025-01-16T12:00:00",
    ...
  }
}

Error Response (401):
{
  "success": false,
  "error": "Missing API key"
}

Error Response (400):
{
  "success": false,
  "error": "Validation failed",
  "details": "..."
}
```

#### Create Batch Log Entries
```
POST /api/v1/logs/batch
Content-Type: application/json
X-API-Key: mlk_xxxxx...

Request Body: Array of log entry objects (max 100)
[
  { "title": "Entry 1", "content": "..." },
  { "title": "Entry 2", "content": "..." }
]

Success Response (201):
{
  "success": true,
  "created": 2,
  "failed": 0,
  "entries": [...],
  "errors": []
}

Partial Success Response (207 Multi-Status):
{
  "success": false,
  "created": 1,
  "failed": 1,
  "entries": [...],
  "errors": ["Entry 1: validation error..."]
}
```

## Integration Requirements

### manifest.json

```json
{
  "domain": "mylog",
  "name": "MyLog",
  "codeowners": ["@your-github-username"],
  "config_flow": true,
  "documentation": "https://github.com/your-username/homeassistant-mylog",
  "integration_type": "service",
  "iot_class": "cloud_push",
  "issue_tracker": "https://github.com/your-username/homeassistant-mylog/issues",
  "requirements": ["aiohttp>=3.8.0"],
  "version": "1.0.0"
}
```

### hacs.json

```json
{
  "name": "MyLog",
  "homeassistant": "2024.1.0",
  "render_readme": true
}
```

### Configuration Flow (GUI)

The integration **must** provide a graphical configuration flow in Home Assistant. This is the standard way users configure integrations - they go to Settings → Devices & Services → Add Integration → MyLog.

**Important:** Users need to obtain an API key from the mylog web application first:
1. Log in to https://mylog.zip
2. Go to Settings → API Keys
3. Create a new API key
4. Copy the key (starts with `mlk_`)

The config flow GUI should:

1. **Display instructions** - Tell users they need an API key from mylog.zip
2. **Collect API Key** - Single text input field for the API key
3. **Validate** - Test the API key against the mylog API
4. **Show errors** - Display meaningful error messages if validation fails

Validation steps:
1. Check that the API key starts with `mlk_` prefix
2. Test connection by calling `/health` endpoint
3. Verify API key is valid by making a test request to `/api/v1/logs`

Store configuration in `config_entry.data`:
```python
{
  "api_key": "mlk_xxxxx..."
}
```

### Config Flow Implementation (config_flow.py)

```python
"""Config flow for MyLog integration."""
import voluptuous as vol
from homeassistant import config_entries
from homeassistant.const import CONF_API_KEY
from homeassistant.data_entry_flow import FlowResult

from .api import MyLogApi, MyLogApiError, MyLogAuthError, MyLogConnectionError
from .const import DOMAIN

class MyLogConfigFlow(config_entries.ConfigFlow, domain=DOMAIN):
    """Handle a config flow for MyLog."""

    VERSION = 1

    async def async_step_user(self, user_input: dict | None = None) -> FlowResult:
        """Handle the initial step - API key entry."""
        errors: dict[str, str] = {}

        if user_input is not None:
            api_key = user_input[CONF_API_KEY].strip()

            # Validate API key format
            if not api_key.startswith("mlk_"):
                errors["base"] = "invalid_api_key_format"
            else:
                # Test the API key
                api = MyLogApi(api_key)
                try:
                    await api.health_check()
                    # Optionally test auth by making a request
                    # This validates the key is actually valid
                    await api.close()

                    # Create the config entry
                    return self.async_create_entry(
                        title="MyLog",
                        data={CONF_API_KEY: api_key},
                    )
                except MyLogAuthError:
                    errors["base"] = "invalid_auth"
                except MyLogConnectionError:
                    errors["base"] = "cannot_connect"
                except MyLogApiError:
                    errors["base"] = "unknown"
                finally:
                    await api.close()

        # Show the form
        return self.async_show_form(
            step_id="user",
            data_schema=vol.Schema({
                vol.Required(CONF_API_KEY): str,
            }),
            errors=errors,
            description_placeholders={
                "mylog_url": "https://mylog.zip",
            },
        )
```

### Translations (strings.json / translations/en.json)

```json
{
  "config": {
    "step": {
      "user": {
        "title": "Connect to MyLog",
        "description": "Enter your MyLog API key. You can create one at {mylog_url} under Settings → API Keys.",
        "data": {
          "api_key": "API Key"
        }
      }
    },
    "error": {
      "invalid_api_key_format": "Invalid API key format. Key must start with 'mlk_'",
      "invalid_auth": "Invalid API key. Please check your key and try again.",
      "cannot_connect": "Cannot connect to MyLog. Please check your internet connection.",
      "unknown": "An unexpected error occurred."
    },
    "abort": {
      "already_configured": "MyLog is already configured."
    }
  }
}
```

### Services

Expose these services:

#### mylog.send_log

Primary service for sending log entries.

```yaml
# services.yaml
send_log:
  name: Send Log Entry
  description: Send a log entry to MyLog
  fields:
    title:
      name: Title
      description: Log entry title (max 500 characters)
      required: false
      example: "Home Assistant Event"
      selector:
        text:
    content:
      name: Content
      description: Log entry content/message
      required: false
      example: "Motion detected in living room"
      selector:
        text:
          multiline: true
    type_name:
      name: Log Type
      description: Name of the log type (must exist in user's mylog)
      required: false
      example: "Home Assistant"
      selector:
        text:
    severity:
      name: Severity
      description: Severity level
      required: false
      default: "info"
      selector:
        select:
          options:
            - "info"
            - "low"
            - "medium"
            - "high"
            - "critical"
    priority:
      name: Priority
      description: Priority (0-100)
      required: false
      default: 0
      selector:
        number:
          min: 0
          max: 100
    tags:
      name: Tags
      description: List of tags
      required: false
      example: ["automation", "motion"]
      selector:
        object:
    location_name:
      name: Location
      description: Location name
      required: false
      example: "Living Room"
      selector:
        text:
```

#### mylog.send_batch (optional)

For advanced users sending multiple entries at once.

### API Client (api.py)

```python
"""MyLog API Client"""
import aiohttp
from typing import Any

# Fixed API URL - mylog.zip is the only instance
API_BASE_URL = "https://mylog.zip/fastAPI"

class MyLogApiError(Exception):
    """Base exception for MyLog API errors."""
    pass

class MyLogAuthError(MyLogApiError):
    """Authentication error."""
    pass

class MyLogConnectionError(MyLogApiError):
    """Connection error."""
    pass

class MyLogApi:
    """Async client for MyLog API."""

    def __init__(self, api_key: str) -> None:
        self._api_url = API_BASE_URL
        self._api_key = api_key
        self._session: aiohttp.ClientSession | None = None

    @property
    def _headers(self) -> dict[str, str]:
        return {
            "Content-Type": "application/json",
            "X-API-Key": self._api_key,
        }

    async def _get_session(self) -> aiohttp.ClientSession:
        if self._session is None or self._session.closed:
            self._session = aiohttp.ClientSession()
        return self._session

    async def close(self) -> None:
        if self._session and not self._session.closed:
            await self._session.close()

    async def health_check(self) -> dict[str, Any]:
        """Check API health."""
        session = await self._get_session()
        try:
            async with session.get(
                f"{self._api_url}/health",
                timeout=aiohttp.ClientTimeout(total=10)
            ) as response:
                if response.status != 200:
                    raise MyLogConnectionError(f"Health check failed: {response.status}")
                return await response.json()
        except aiohttp.ClientError as err:
            raise MyLogConnectionError(f"Connection failed: {err}") from err

    async def create_log_entry(
        self,
        title: str | None = None,
        content: str | None = None,
        type_name: str | None = None,
        severity: str = "info",
        priority: int = 0,
        tags: list[str] | None = None,
        location_name: str | None = None,
        **kwargs
    ) -> dict[str, Any]:
        """Create a log entry."""
        payload = {
            k: v for k, v in {
                "title": title,
                "content": content,
                "type_name": type_name,
                "severity": severity,
                "priority": priority,
                "tags": tags,
                "location_name": location_name,
                **kwargs
            }.items() if v is not None
        }

        session = await self._get_session()
        try:
            async with session.post(
                f"{self._api_url}/api/v1/logs",
                json=payload,
                headers=self._headers,
                timeout=aiohttp.ClientTimeout(total=30)
            ) as response:
                data = await response.json()

                if response.status == 401:
                    raise MyLogAuthError(data.get("error", "Authentication failed"))
                if response.status >= 400:
                    raise MyLogApiError(data.get("error", f"API error: {response.status}"))

                return data
        except aiohttp.ClientError as err:
            raise MyLogConnectionError(f"Connection failed: {err}") from err
```

### Integration Setup (__init__.py)

```python
"""MyLog Integration."""
from homeassistant.config_entries import ConfigEntry
from homeassistant.core import HomeAssistant, ServiceCall
from homeassistant.exceptions import ConfigEntryNotReady

from .api import MyLogApi, MyLogConnectionError
from .const import DOMAIN

async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """Set up MyLog from a config entry."""
    api = MyLogApi(entry.data["api_key"])

    try:
        await api.health_check()
    except MyLogConnectionError as err:
        await api.close()
        raise ConfigEntryNotReady(f"Cannot connect to MyLog: {err}") from err

    hass.data.setdefault(DOMAIN, {})
    hass.data[DOMAIN][entry.entry_id] = api

    # Register services
    async def handle_send_log(call: ServiceCall) -> None:
        """Handle send_log service call."""
        await api.create_log_entry(
            title=call.data.get("title"),
            content=call.data.get("content"),
            type_name=call.data.get("type_name"),
            severity=call.data.get("severity", "info"),
            priority=call.data.get("priority", 0),
            tags=call.data.get("tags"),
            location_name=call.data.get("location_name"),
        )

    hass.services.async_register(DOMAIN, "send_log", handle_send_log)

    return True

async def async_unload_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """Unload a config entry."""
    api: MyLogApi = hass.data[DOMAIN].pop(entry.entry_id)
    await api.close()
    return True
```

## Example Automations

Users can then use the integration in automations:

```yaml
# Example automation
automation:
  - alias: "Log Motion Detection"
    trigger:
      - platform: state
        entity_id: binary_sensor.living_room_motion
        to: "on"
    action:
      - service: mylog.send_log
        data:
          title: "Motion Detected"
          content: "Motion detected in {{ trigger.to_state.attributes.friendly_name }}"
          type_name: "Home Assistant"
          severity: "info"
          tags:
            - motion
            - security
          location_name: "Living Room"

  - alias: "Log Temperature Alert"
    trigger:
      - platform: numeric_state
        entity_id: sensor.outdoor_temperature
        above: 35
    action:
      - service: mylog.send_log
        data:
          title: "High Temperature Alert"
          content: "Outdoor temperature is {{ states('sensor.outdoor_temperature') }}°C"
          severity: "high"
          tags:
            - temperature
            - alert
```

### Constants (const.py)

```python
"""Constants for the MyLog integration."""

DOMAIN = "mylog"
```

## Testing Checklist

1. [ ] Config flow GUI displays correctly in Home Assistant
2. [ ] Config flow shows instructions to get API key from mylog.zip
3. [ ] Config flow validates API key format (must start with `mlk_`)
4. [ ] Config flow tests API connection with health check
5. [ ] Config flow handles connection errors gracefully with user-friendly messages
6. [ ] Service `mylog.send_log` creates entries successfully
7. [ ] Service handles API errors and logs appropriately
8. [ ] Integration reconnects after temporary disconnection
9. [ ] Unloading integration closes API session cleanly
10. [ ] All strings have English and German translations

## HACS Publication

1. Create GitHub repository `homeassistant-mylog`
2. Add `hacs.json` to repository root
3. Create a GitHub release with semantic versioning
4. Add repository to HACS default repositories or instruct users to add as custom repository

## Additional Features (Optional)

Consider implementing:

1. **Sensors** - Show last log entry status, count of entries today
2. **Diagnostics** - Export connection status for troubleshooting
3. **Events** - Fire HA events when log entry is created
4. **Device Tracker** - If location data is relevant
5. **Rate Limiting** - Prevent accidental spam to the API
